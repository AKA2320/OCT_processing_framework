# .github/workflows/macos_build.yml
name: Build macOS Executable

on:
  push:
    tags:
      - 'v*.*.*' # Trigger on pushes to tags like v1.0.0

jobs:
  build:
    runs-on: macos-latest # Use the latest macos runner

    steps:
    - name: Checkout code
      uses: actions/checkout@v4 # Action to checkout your repository code

    - name: Set up Python
      uses: actions/setup-python@v5 # Action to set up Python
      with:
        python-version: '3.12.10' # Specify the Python version

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller # Install PyInstaller
        # Add any other project-specific dependencies here, e.g.:
        # pip install napari PySide6 torch ultralytics h5py natsort torchvision tqdm timm ml_collections pydicom skimage scipy bokeh

    - name: Build with PyInstaller
      run: pyinstaller OCT_mac_app.spec

    - name: Zip macos executable
      run: |
        cd dist
        # Create a zip file of the executable.
        # The name 'OCT_mac_app.app' should match the 'name' in your macos spec file's EXE object.
        zip -r OCT_mac_app.zip OCT_mac_app.app
        ls -l # List files to verify the zip
      shell: pwsh # Use PowerShell for zip command on macos runner

    - name: Upload artifact
      uses: actions/upload-artifact@v4 # Action to upload the built executable as an artifact
      with:
        name: OCT_mac_app # Name of the artifact
        path: dist/OCT_mac_app.zip # Path to the zipped executable

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/') # Only run if triggered by a tag push
      uses: softprops/action-gh-release@v2 # Action to create a GitHub Release
      with:
        files: dist/OCT_mac_app.zip # Path to the file to upload to the release
        name: Release ${{ github.ref_name }} - macOS # Name of the release (e.g., Release v1.0.0 - macos)
        tag_name: ${{ github.ref_name }} # Tag name (e.g., v1.0.0)
        draft: false # Set to true to create a draft release
        prerelease: false # Set to true for a pre-release
